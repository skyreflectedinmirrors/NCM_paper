%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                          template.tex
%
% LaTeX template for papers conforming to the United States Sections of
% the Combustion Institue style guide.
%
% Authors:
%     Bryan W. Weber, University of Connecticut
%     Kyle E. Niemeyer, Oregon State University
%
% This work is licensed under the Creative Commons Attribution 4.0
% International License. To view a copy of this license, visit
% http://creativecommons.org/licenses/by/4.0/.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[12pt]{ussci}

%======================================================================
\usepackage{todonotes}
\usepackage{graphicx}
\usepackage[binary-units]{siunitx}
\usepackage{gensymb}
\usepackage{amsmath}
\usepackage[version=3]{mhchem} % Formula subscripts using \ce{}, e.g., \ce{H2SO4}
\usepackage{booktabs,multicol} %better tables
\sisetup{group-separator={,},
	detect-all,
	binary-units,
	list-units = single,
	range-units = single,
	range-phrase = --,
	per-mode = symbol-or-fraction,
	separate-uncertainty = true,
	multi-part-units = single,
	list-final-separator = {, and }
	%    scientific-notation = fixed
}
%======================================================================
% Add your bibliography file here, replace template.bib
\addbibresource{paper.bib}
%======================================================================
% Replace "Reaction Kinetics" in the line below by your paper topic
\newcommand\papertopic{Reaction Kinetics}
%======================================================================

\title{ Title of Paper }

\author[1]{Author Name}
\author[1]{Author Name}
\author[2]{Author Name}
\author[2,*]{Author Name}

\affil[1]{Department, Institution, Address, Country}
\affil[2]{Department, Institution, Address, Country}
\affil[*]{Corresponding author: \email{author@university.edu}}

\begin{document}
\maketitle

%====================================================================
\begin{abstract} % not to exceed 200 words
Abstract should be between 150--200 words and should state briefly the purpose
of the research, the principal results and major conclusions. An abstract is
often presented separately from the article, so it must be able to stand alone.
For this reason, References should be avoided, but if essential, then cite the
author(s) and year(s). Also, non-standard or uncommon abbreviations should be
avoided, but if essential they must be defined at their first mention in the
abstract itself.
\end{abstract}

% (Provide 2-4 keywords describing your research. Only abbreviations firmly
% established in the field may be used. These keywords will be used for
% sessioning/indexing purposes.)
\begin{keyword}
    Keyword1\sep Keyword2\sep Keyword3\sep Keyword4
\end{keyword}

%====================================================================
\section{Introduction}
%

Single Instruction, Multiple-Data (SIMD) processing, also known as vector-processing, is an important parallel computing paradigm used increasingly in scientific computing.
While central processing unit (CPU) clock speeds have increased rapidly over the past few decades---the phenomena known as Moore's Law---power consumption and head dissipation issues have caused this trend to slow.
Traditional multi-core parallelism is often used to increase CPU performance, however SIMD processors---and the related Single Instruction, Multiple Thread (SIMT) processors, e.g. graphics processing units (GPUs)---have gained recognition due to their increased floating operation throughput.
The parallel programming standard OpenCL~\cite{stone2010opencl} has further enabled adoption of vector-processing based codes in scientific computing by providing a common application program interface (API) for execution on heterogeneous systems (e.g. CPU, GPU, etc.).

\begin{figure}[ht]
	\centering
	\includegraphics[width=0.33\linewidth]{SIMD.pdf}
	\caption{Schematic of SIMD processing.  A single processing element (e.g. a CPU core) contains a vector unit with several lanes (L0, L1, etc.).  The vector unit executes a single instruction concurrently on multiple data. Adapted from\cite{Simdfig:2016}}
	\label{F:SIMD}
\end{figure}

A SIMD instruction utilizes specialized vector processing hardware to execute the same floating point operation (e.g. multiplication, division, etc.) on multiple pieces of data concurrently (Fig.~\ref{F:SIMD}).
Nearly all modern CPUs have vector processing units capable of running SIMD instructions, typically capable of handling 2--4 concurrent double precision operations---known as the vector width.
Additionally, specialized hardware accelerators, e.g. Intel's Xeon Phi co-processor (or MIC), have been developed that have tens of cores with very wide vector widths (e.g. 4--8 double precision operations); these very wide vector widths are also expected on forthcoming Intel CPUs (the Skylake Xeon and Cannon Lake architectures).

Several recent works, e.g. \cite{CurtisGPU:2017,Sewerin20151375} have investigated SIMT-based chemical kinetic integration on GPUs, however SIMD-based chemical kinetics have been less studied in comparison.
\textcite{stone2016} implemented a linearly-implicit fourth-order stiff Rosenbrock solver in the OpenCL for various platforms including the CPU, GPU and the MIC; the Rosenbrock solver performance was compared to that of a non-stiff, fourth-order explicit Runge–Kutta–Fehlberg integrator.
Two parallelization models were investigated in OpenCL, the so called \textit{shallow}-SIMD vectorization, where each SIMD-lane solved a single chemical kinetic initial value problem (IVP), and a SIMT-vectorization where each thread solved a single IVP.
Shallow-SIMD vectorization improved the integrator performance over the OpenMP baseline by \SIrange{2.5}{2.8}{$\times$} on the CPU and \SIrange{4.7}{4.9}{$\times$} on the MIC, while the GPU performance while the GPU was \SIrange{1.4}{1.6}{$\times$} slower than the OpenMP baseline due to thread-divergence concerns.
\textcite{kroshko2013efficient} implemented a shallow-SIMD -vectorized third order Rosenbrock solver (RODAS) integrator for atmospheric chemistry on a Cell Broadband Engine---a specially designed vector processor---finding a speedup of \SI{1.89}{$\times$} over a serial version of the same code, a \SI{94}{\percent} parallel efficiency.

This work will study the performance of chemical source term evaluation of automatically generated shallow-SIMD-vectorized codes for a wide range chemical kinetic models on the CPU.
The performance will be compared to a baseline SIMT-vectorized codes to determine the effective SIMD speedup.
Finally future extensions to this work will be detailed.

\section{Methodology}
\subsection{Chemical Kinetics Equations}
The current code evaluates the following chemical source terms:

\begin{equation}
\frac{\text{d}[C_k]}{\text{d}t} = \sum_{i}^{N_R} \nu_{k,i} R_i c_i
\end{equation}
where $\frac{\text{d}[C_k]}{\text{d}t}$, $N_R$, $\nu_{k,i}$, ${R_i}$, $c_i$ are the time rate of change of the concentration of species $k$, the number of reactions in the model, the net stoichiometric coefficient of species $k$ in reaction $i$, the net rate of progress of reaction $i$, and the pressure modification of reaction $i$ respectively.
For further detail on each term, the reader is referred to our previous work~\cite{Niemeyer:2016aa}; the code is capable of evaluating all modern reaction rate types (e.g. pressure-log, chebyshev, etc.).

In addition, the temperature rate of change using the constant-pressure assumption\footnote{Note: in this context, the ``constant-pressure assumption'' refers to evaluation within a reaction sub-step in the operator splitting scheme, rather than a general constant-pressure reactive-flow simulation.} is evaluated as:
\begin{equation}
\frac{\text{d}[T]}{\text{d}t} = -\frac{\sum_{k}^{N_S} H^{\degree}_k \frac{\text{d}[C_k]}{\text{d}t}}{\sum_{k}^{N_S} [C_k] c_{p_k}^{\degree}}
\end{equation}
although the code is equally capable of a evaluating the temperature rate using a constant-volume assumption, we omit this here for brevity.

\subsection{Code Generation}
Code generation is handled by the python package \texttt{loo.py}~\cite{kloeckner_loopy_2014}, which provides an interface to OpenCL allowing for unit testing and changes of program structure, e.g. data ordering, vectorization, threading patterns etc.
Additionally, \texttt{loo.py} allows for code generation for multiple languages, including (non-vectorized) C, CUDA, and Intel's ISPC compiler, which targets SIMD vectorization on the CPU and MIC.
This is a direction that may be explored in the future to compare the speedups of the various compilers.

\subsection{Data Ordering and Vectorization Patterns}
For a chemical kinetic model with species $k$ for the $j$-th thermo-chemical state to be evaluated, $[C_k]_j$ there are two choices for data-storage in memory.
In the ``C'' (C row-major) format, species concentrations for $j$-th thermo-chemical state are stored sequentially in memory.
Alternatively, in the ``F'' (Fortan column-major) format species concentrations a single species for over all thermo-chemical states are adjacent in memory.
In Sec.~\ref{S:results} the effect of this ordering will be shown to have a large performance impact on the program runtime.

In this work, a \textit{shallow}-SIMD vectorization has been implemented, entailing each SIMD-lane evaluating chemical source terms for an thermo-chemical state independently.
In future efforts, a so called \textit{deep}-SIMD vectorization will be pursued allowing vector-units to cooperate to evaluate species rates for a single thermo-chemical state.
A deep-vectorization may result in SIMD-\textit{waste} in this context---similar to thread-divergence in SIMT-processing---caused by different SIMD-lanes executing different instructions (e.g. from differing for-loop bounds).
However a deep-vectorization will likely have higher cache hit-rates than a shallow-vectorization using the ``C'' memory layout as successive SIMD-lanes would access directly memory adjacent locations.
Additionally, past studies demonstrate the merits of deep-SIMT vectorization on GPUs~\cite{Sewerin20151375}.

\section{Results and Discussion}
\subsection{Validation}
The reaction rates of progress (ROP), species and temperature rates in this study are validated by comparison with Cantera~\cite{Cantera}, however special care must be taken due floating point arithmetic issues

In computing the net rate of progress of reaction $i$ from the forward and reverse ROP: $R_{i} = R_{i}^{\prime} - R_{i}^{\prime\prime}$, precision can easily be lost as the net rate of progress may be---particularly near chemical equilibrium---many orders of magnitude smaller than the forward or reverse rates.
A base-ten bound on loss of precision~\cite{goldberg1991every} can be found as:
\begin{equation}
\text{P}_{\text{min},i} = 2^{-p_i} \le \left\lvert 1 - \frac{R_{i}^{\prime}}{R_{i}^{\prime\prime}} \right\rvert \le 2^{-q_i} = \text{P}_{\text{max},i}
\label{e:bounds}
\end{equation}
with $q_i \le p_i$.
To obtain an estimate of the a-priori precision bounds ($\text{P}_{\text{min},i}$ and $\text{P}_{\text{max},i}$), the forward and reverse ROP from Cantera are substituted into Eq.~\eqref{e:bounds}.
Additionally a higher-precision number format (in this case, the Python Decimal class) is used in this computation to maintain accuracy.
Finally, when determining the error in the net ROP between this code and Cantera, the bounds on the percent error attributable to precision loss, $\text{P}_{\text{err},i}$ can be estimated as:
\begin{equation}
\text{P}_{i,\text{min}} = 100 * \frac{\text{P}_{\text{min},i}}{\left\lvert\ R_{i,\text{CT}} - R_{i}\right\rvert} \le
\text{P}_{i} \le 100 * \frac{\text{P}_{\text{max},i}}{\left\lvert R_{i,\text{CT}} - R_{i} \right\rvert} = \text{P}_{i,\text{max}}
\label{e:rel_bound}
\end{equation}
where the \text{CT} subscript indicates values from Cantera.

For a more direct comparison, a relative error norm of a quantity $X_{i,j}$ over all states $j$, and indices $i$ was computed using the $L^{\infty}$ norm:
\begin{equation}
 E_{X_{i}} = \left\lVert \frac{\left\lvert X_{i,j,\text{CT}} - X_{i,j}\right\rvert}{\num{e-10} + \num{e-6} * \left\lvert X_{i,j,\text{CT}} \right\rvert} \right\rVert_{i,j,\infty}
\label{e:rel_err}
\end{equation}
and the lower precision bound for the net rate of progress error norm is set to $P_{\text{min}}^{*} = P_{i,\text{min}}$ for the $i, j$ value that results in the maximum error $E_{R_i}$.

\begin{table}[ht]
\sisetup{retain-zero-exponent=true}
\centering
\begin{tabular}{@{}S[table-format=1.2e1] S[table-format=1.2e1] S[table-format=1.2e1] S[table-format=1.2e1] S[table-format=1.2e1] S[table-format=1.2e1] S[table-format=1.2e1] @{}}
\toprule
\multicolumn{1}{c}{Model} & \multicolumn{1}{c}{$E_{R_{i}^{\prime}}$} & \multicolumn{1}{c}{$E_{R_{i}^{\prime\prime}}$} &\multicolumn{1}{c}{$E_{R_{i}}$} & \multicolumn{1}{c}{$\text{P}_{\text{min}}^{*}\si{\percent}$} & \multicolumn{1}{c}{$E_{\frac{\text{d}[C_k]}{\text{d}t}}$} & \multicolumn{1}{c}{$E_{\frac{\text{d}[T]}{\text{d}t}}$} \\
\midrule
\multicolumn{1}{c}{\ce{H2}\slash~\ce{CO}} & 1.20e-8 & 6.33e-8 & 1.32e1 & 4.66e6 & 2.37e1 & 2.12e5 \\
\multicolumn{1}{c}{GRI-Mech.~3.0}  & 3.07e-8 & 5.90e-8 & 1.21e0 & 2.67e04 & 2.84e0 & 2.64e4 \\
\multicolumn{1}{c}{USC-Mech II}  & 1.07e-7 & 1.37e-7 & 2.39e0 & 4.12e02 & 7.92e00 & 3.22e03 \\
\bottomrule
\end{tabular}
\caption{Summary of rate of progress, species and temperature rate correctness.
Error statistics are based on the infinity-norm of the relative error detailed in Eq.~\eqref{e:rel_err} for each quantity.
\todo[inline]{i-pentanol validation still running}
}
\label{T:error}
\end{table}

In Table~\ref{T:error}, we see the results of this code as compared to Cantera on a library of partially stirred reaction conditions described in our previous works~\cite{CurtisGPU:2017,Niemeyer:2016aa}.
Very close agreement is observed for the forward and reverse ROP for all models, however the net rate of progress is \numrange{7}{8} orders of magnitude larger.
We see here that the minimum estimated loss of precision is \SIrange{4}{40}{$\times$} the error in net ROP, explaining this jump.
The species rate error norm is similar in magnitude to that of the net ROP, however the temperature rate error again increases as it depends directly on the species rates.
We note that the above discussion does not imply that computation of the net ROP will cause large error in chemical kinetic integration---either in this code or Cantera---as this loss of precision only occurs when the net ROP are many orders of magnitude smaller than the forward or reverse rates, implying the reaction is in near-equilibrium.

\subsection{Results}
\label{S:results}


\label{results}

\section{Conclusions}
%

\section{Acknowledgements}
This research was funded by \ldots

\noindent\textbf{Page Limits:} The total length of the paper including references should be limited to 6 pages.

\printbibliography[heading=bibintoc]

\end{document}
